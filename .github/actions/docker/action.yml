name: Build and push docker

inputs:
  dockerfile:
    description: "Location of the Dockerfile to use. Parent directory will be used as context."
    required: true
  node-version:
    description: "The node version to include in the dockerfile"
    required: true
  package-version:
    description: "The package version to install"
    required: true
  push:
    description: "Whether to push the docker image or not"
    default: "false"
    required: false
  channel:
    description: "The channel tag to add"
    required: true
  dockerhub-repo:
    description: "The Docker Hub repository to push to (e.g. 303316404/home-assistant-matter-hub)"
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Build metadata
      id: meta
      shell: bash
      env:
        DOCKER_IMAGE_BASENAME: ghcr.io/${{ github.repository }}
      run: |
        CONTEXT=$(dirname "${{inputs.dockerfile}}")
        DOCKER_TYPE=$(basename "${{inputs.dockerfile}}" .Dockerfile)

        if [ "$DOCKER_TYPE" = "standalone" ]; then
          DOCKER_IMAGE="${DOCKER_IMAGE_BASENAME}"
          DOCKERHUB_IMAGE="${{ inputs.dockerhub-repo }}"
        else
          DOCKER_IMAGE="${DOCKER_IMAGE_BASENAME}-$DOCKER_TYPE"
          if [ -n "${{ inputs.dockerhub-repo }}" ]; then
            DOCKERHUB_IMAGE="${{ inputs.dockerhub-repo }}-$DOCKER_TYPE"
          fi
        fi
        
        echo "dockertag=$DOCKER_IMAGE" >> "$GITHUB_OUTPUT"
        echo "dockerhubtag=$DOCKERHUB_IMAGE" >> "$GITHUB_OUTPUT"
        echo "context=$CONTEXT" >> "$GITHUB_OUTPUT"

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        push: ${{inputs.push}}
        platforms: linux/amd64,linux/arm/v7,linux/arm64/v8
        context: ${{ steps.meta.outputs.context }}
        file: ${{inputs.dockerfile}}
        build-args: |
          NODE_VERSION=${{ inputs.node-version }}
          PACKAGE_VERSION=${{ inputs.package-version }}
        tags: |
          ${{ steps.meta.outputs.dockertag }}:${{ inputs.package-version }}
          ${{ steps.meta.outputs.dockertag }}:${{ inputs.channel }}
          ${{ steps.meta.outputs.dockerhubtag != '' && format('{0}:{1}', steps.meta.outputs.dockerhubtag, inputs.package-version) || '' }}
          ${{ steps.meta.outputs.dockerhubtag != '' && format('{0}:{1}', steps.meta.outputs.dockerhubtag, inputs.channel) || '' }}
